# Tasks Endpoints Blueprint Tests
# 
# Tests all task-related endpoints for availability, correct response format,
# and proper error handling. These are shallow tests focused on breadth.

version: "1.1"
name: Tasks Blueprint

tests:
  # ===========================================================================
  # Standard Methods (CRUD)
  # ===========================================================================
  
  list_tasks:
    name: List Tasks
    steps:
      - name: GET /v1/tasks - 200 with empty filters
        http:
          url: http://localhost:3000/api/v1/tasks
          method: GET
          timeout: 5000
          check:
            status: 200

      - name: GET /v1/tasks - 200 with category filter
        http:
          url: http://localhost:3000/api/v1/tasks?category=work
          method: GET
          timeout: 5000
          check:
            status: 200

      - name: GET /v1/tasks - 200 with priority filter
        http:
          url: http://localhost:3000/api/v1/tasks?priority=4
          method: GET
          timeout: 5000
          check:
            status: 200

      - name: GET /v1/tasks - 200 with limit
        http:
          url: http://localhost:3000/api/v1/tasks?limit=5
          method: GET
          timeout: 5000
          check:
            status: 200

      - name: GET /v1/tasks - 200 with pagination
        http:
          url: http://localhost:3000/api/v1/tasks?limit=10&offset=0
          method: GET
          timeout: 5000
          check:
            status: 200

  get_task:
    name: Get Single Task
    steps:
      - name: GET /v1/tasks/{id} - 404 Not Found
        http:
          url: http://localhost:3000/api/v1/tasks/nonexistent-task-id
          method: GET
          timeout: 5000
          check:
            status: 404

  # NOTE: create_task is disabled in mock mode because the Todoist SDK v6
  # has strict response validation that requires exact field matching.
  # This test passes in real mode (test:step-ci:real).
  # To fix for mock mode: run `pnpm test:step-ci:record` to capture real response.
  # create_task:
  #   name: Create Task
  #   steps:
  #     - name: POST /v1/tasks - 201 Created
  #       http:
  #         url: http://localhost:3000/api/v1/tasks
  #         method: POST
  #         headers:
  #           Content-Type: application/json
  #         json:
  #           content: "Blueprint test task - will be deleted"
  #           priority: 2
  #         timeout: 5000
  #         check:
  #           status: 201
  #         captures:
  #           createdTaskId:
  #             jsonpath: $.id
  # 
  #     - name: DELETE created task (cleanup)
  #       http:
  #         url: http://localhost:3000/api/v1/tasks/${{ captures.createdTaskId }}
  #         method: DELETE
  #         timeout: 5000
  #         check:
  #           status: /^(204|404)$/

  update_task:
    name: Update Task
    steps:
      - name: PATCH /v1/tasks/{id} - 404 Not Found
        http:
          url: http://localhost:3000/api/v1/tasks/nonexistent-task-id
          method: PATCH
          headers:
            Content-Type: application/json
          json:
            content: "Updated content"
          timeout: 5000
          check:
            status: 404

  delete_task:
    name: Delete Task
    steps:
      - name: DELETE /v1/tasks/{id} - 404 Not Found
        http:
          url: http://localhost:3000/api/v1/tasks/nonexistent-task-id
          method: DELETE
          timeout: 5000
          check:
            status: 404

  # ===========================================================================
  # Custom Methods
  # ===========================================================================

  sync_tasks:
    name: Sync Tasks
    steps:
      - name: POST /v1/tasks/sync - 200 OK
        http:
          url: http://localhost:3000/api/v1/tasks/sync
          method: POST
          headers:
            Content-Type: application/json
          json:
            fullSync: false
          timeout: 30000
          check:
            status: 200

  complete_task:
    name: Complete Task
    steps:
      - name: POST /v1/tasks/{id}/complete - 404 Not Found
        http:
          url: http://localhost:3000/api/v1/tasks/nonexistent-task-id/complete
          method: POST
          headers:
            Content-Type: application/json
          json:
            actualMinutes: 30
          timeout: 5000
          check:
            status: 404

  search_tasks:
    name: Search Tasks
    steps:
      - name: POST /v1/tasks/search - 200 OK
        http:
          url: http://localhost:3000/api/v1/tasks/search
          method: POST
          headers:
            Content-Type: application/json
          json:
            query: "test"
            limit: 10
          timeout: 5000
          check:
            status: 200

  batch_update:
    name: Batch Update Tasks
    steps:
      - name: POST /v1/tasks/batchUpdate - 200 OK (empty)
        http:
          url: http://localhost:3000/api/v1/tasks/batchUpdate
          method: POST
          headers:
            Content-Type: application/json
          json:
            updates: []
          timeout: 5000
          check:
            status: 200
